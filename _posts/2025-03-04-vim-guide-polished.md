## Vim 实用指南

### 引言

大家好，我是TwelveNight。在这个与键盘密切相关的职业中，我们不断寻找提高效率的方法。那么，如何才能更有效地利用键盘进行代码编写呢？我的答案是——使用Vim。

Vim 是一款由 Bram Moolenaar 设计的高效文本编辑器，它的设计初衷就是减少手指在键盘上的移动，从而提升编程效率。自从1991年首次发布以来，Vim已经发展成为一种强大且灵活的工具，被广泛应用于各种编程语言的开发中。

选择 Vim 作为我们探讨的主题，不仅因为它是一种高效的编程工具，更重要的是，它代表了一种追求精确、高效工作方式的态度。无论你是一名经验丰富的Vim用户，还是刚接触Vim的新手，本指南都旨在帮助你更深入地理解和掌握这款神奇的编辑器。

让我们一起探索Vim的世界，发现它如何能够改变我们的编程体验，并将其变成我们日常工作中的必备技能。

### 缓存、标签页、窗口

Vim 会维护一系列打开的文件，称为"缓存"。一个Vim会话包含一系列标签页，每个标签页包含一系列窗口（分隔面板）。每个窗口显示一个缓存。与网页浏览器等其他你熟悉的程序不同，缓存和窗口不是一一对应的关系；窗口只是视角。一个缓存可以在多个窗口打开，甚至在同一个标签页内的多个窗口打开。这个功能其实很好用，比如在查看同一个文件的不同部分的时候。

Vim 默认打开一个标签页，这个标签页包含一个窗口。

### 模式

- **正常模式**：在文件中四处移动光标进行修改
- **插入模式**：插入文本
- **替换模式**：替换文本
- **视觉模式**（一般，行，块）：选中文本块
- **命令模式**：用于执行命令

### 常用操作

#### 命令行

在普通模式下键入`:`进入命令行模式。在键入`:`后，你的光标会立即跳到屏幕下方的命令行。这个模式有很多功能，包括打开、保存、关闭文件，以及退出Vim。

- `:q` 退出（关闭窗口）
- `:w` 保存（写）
- `:wq` 保存然后退出
- `:e {文件名}` 打开要编辑的文件
- `:ls` 显示打开的缓存
- `:help {标题}` 打开帮助文档
- `:help :w` 打开`:w`命令的帮助文档
- `:help w` 打开`w`移动的帮助文档

#### 基础键位

**移动**：
- `hjkl`：分别对应左、下、上、右方向的移动
- 词：`w`（下一个词首）、`b`（前一个词首）、`e`（本词尾）
- 行：`0`（行首）、`$`（行尾）
- `%`：匹配括号
- 文件：`gg`（文件开头）、`G`（文件结尾）

**插入**：
- `i`：在当前光标位置之前插入字符
- `a`：在当前光标位置之后插入字符
- `I`：在当前行首插入字符
- `A`：在当前行尾插入字符
- `o`：在当前行下插入新行
- `O`：在当前行上插入新行

**替换**：
- `r`：替换当前光标所在字符
- `~`：逆转大小写

**删除**：
- `x`：删除当前光标所在字符

**重复**：
- `.`：重复上一个动作，例如`:%s/foo/bar/g`会在全局范围`%`查找`foo`并替换为`bar`，所有出现的`g`都会被替换。

**计数**：
- `3w`：向后移动三个词
- `5j`：向下移动5行
- `7dw`：删除7个词

### Action+Range

#### Action（动作）

**y (yank)** - 复制  
用于复制指定范围内的文本，但不从视图中删除它。复制的文本被存储在Vim的寄存器中，可以随后通过粘贴操作（`p`或`P`）放置到其他位置。

**d (delete)** - 删除  
用于删除指定范围内的文本，并将其存储在寄存器中。删除操作后，文本不再在原位置显示，但可以通过粘贴操作恢复。

**c (change)** - 删除并进入插入模式  
类似于删除操作，但删除文本后立即进入插入模式，允许用户立即开始输入新文本替换被删除的文本。

**v (visual)** - 选中  
进入可视模式，允许用户通过移动光标来选择文本块。选中的文本可以用于复制、删除或改变等操作。

**<< >>** - 行内移动  
将选中行向左或向右移动。

#### Range（范围）

**a (around)** - 包含标志词  
当指定范围时，`a`用于包含某些特定的标志词，如引号、括号或花括号等。例如，`da"`会删除包含双引号内的所有文本，包括双引号本身。

**i (inside)** - 不包含标志词  
与`a`相反，`i`用于指定一个范围，该范围不包括某些特定的标志词。例如，`di"`会删除双引号之间的文本，但不包括双引号本身。

为什么要了解action和range呢？这两者结合可以大大简化我们的操作。

#### 实例：删除双引号中的文字

```cpp
#include <bits/stdc++.h>
using namespace std;
int main() {
    cout << "Hello World!" << endl;
    return 0;
}
```

我们要删除**Hello World!**怎么做？你也许会想先`v`进入可视模式，再通过`hjkl`选中它们，再通过`d`删除，或者更近一步，我们可以先`v`入可视模式再`w`快速选词，但实际上我们有更简单的方法：

`di"`仅仅三个字符就可以完成这个操作，表示我们要删除双引号里的所有内容。

由此引申，`da"`可以连同双引号一同删除，`vi"`选中双引号中的内容，`>i"`可以使main函数内的代码整体右移，**此时我们可以通过`.`快速移动代码块哦**。

### 搜索与替换

#### 搜索

在**normal**模式下按下`/`即可进入查找模式，输入要查找的字符串并按下回车。Vim会跳转到第一个匹配。按下`n`查找下一个，按下`N`查找上一个。

Vim查找支持正则表达式，例如`/vim$`匹配行尾的"vim"。需要查找特殊字符需要转义，例如`/vim\$`匹配"vim$"。[正则表达式简单入门](https://github.com/ziishaned/learn-regex)

#### 替换

`:%s/foo/bar/g`会在全局范围(%)查找`foo`并替换为`bar`，所有出现都会被替换。

语法：`{作用范围}s/{目标}/{替换}/{替换标志}`

**作用范围**：
- `:s/foo/bar/g`作用于当前行
- `:%s/foo/bar/g`作用于全文
- `:'<,'>s/foo/bar/g`作用于视觉模式的选区
- `2,11s/foo/bar/g`作用于2-11行

**替换标志**：

上文中命令结尾的`g`即是替换标志之一，表示全局(global)替换（即替换目标在本行的所有出现）。还有很多其他有用的替换标志：

空替换标志表示只替换从光标位置开始，目标的第一次出现：

```
:%s/foo/bar
```

`i`表示大小写不敏感查找，`I`表示大小写敏感：

```
:%s/foo/bar/i
# 等效于模式中的\c（不敏感）或\C（敏感）
:%s/foo\c/bar
```

`c`表示需要确认，例如全局查找"foo"替换为"bar"并且需要确认：

```
:%s/foo/bar/gc
```

回车后Vim会将光标移动到每一次"foo"出现的位置，并提示：

```
replace with bar (y/n/a/q/l/^E/^Y)?
```

按下`y`表示替换，`n`表示不替换，`a`表示替换所有，`q`表示退出查找模式，`l`表示替换当前位置并退出。`^E`与`^Y`是光标上下移动的快捷键。

### 实用小技巧

- **jump list**: `<C-o>`上一次操作的位置，`<C-i>`更新一次操作的位置，无论是相同文件还是不同文件。
- **部分重命名**：`*`匹配当前内容，`ciw`修改当前内容(`caw`会连同空格一起匹配)，`n`匹配下一个，`N`匹配上一个，`.`重复上一个命令(宏)。
- **将当前光标所在行居中**：可以在insert模式下按`<c-o>`(执行一次normal命令)然后按`zz`使当前行居中。
- **删除所有注释**：进入命令模式：`:%s/\/\/.*//g`
- **删除所有空行**：
  - 查找：`/^\n`（匹配每行的换行符是第一个字符，即空行)
  - 替换：`:%s///`(pattern为空则取上一次搜索的pattern)

### 进阶与杂项

Neovim是Vim的增强版，支持多种多样的插件集成，可以让效率进一步提升。我们可以从Neovim直接开始我们的Vim之旅。

#### LazyVim

这是一个强大而又完善的VimIDE，无论是插件还是配置，LazyVim都提供便捷的默认配置，同时使用者也很多，以至于已经形成了一定的社区规模，在GitHub中的discussion中基本上能够找到80%以上你所遇到的问题。

- [LazyVim官方文档](https://www.lazyvim.org/)
- [discussions](https://github.com/LazyVim/LazyVim/discussions)

#### Neovim插件推荐

插件是Neovim生态中最重要的一环，这一点和VSCode或者其它一些编辑器相同，好的插件可以让我们的生产力大大提升。

- **[code-runner.nvim](https://github.com/CRAG666/code_runner.nvim)**：一键运行，无需繁杂的编译运行操作，对于平时写算法题目会有帮助。
- **[Vim-translator](https://github.com/voldikss/vim-translator)**：比较好用的一个翻译插件。
- **[copilot.lua](https://github.com/zbirenbaum/copilot.lua)**：代码智能补全。
- **[vim-tmux-navigator](https://github.com/christoomey/vim-tmux-navigator)**：结合tmux使用，方便在命令行和nvim窗口快速移动。

#### 嵌入其他应用

Vim并不只是一个编辑器，它还是一门编程语言，所以很多工具都可以通过插件集成Vim，又或者本身就自带Vim模式等待你的发掘：

- [VSCode](https://github.com/VSCodeVim/Vim)
- [JetBrains](https://github.com/JetBrains/ideavim)
- [Zsh](https://github.com/jeffreytse/zsh-vi-mode)
- [Obsidian](https://github.com/esm7/obsidian-vimrc-support)
- [Browser](https://github.com/brookhong/Surfingkeys)

#### 示例配置

这是我的一些个人配置，如有疑问欢迎PR：

- https://github.com/TwelveNight/vim-public
- https://github.com/TwelveNight/dotfiles-rcm

#### 社区

社区是学习一个事物最前沿进展的强大工具，在Vim的社区里你每天都可以看到一些有意思的插件又或者配置，总有一些你会觉得很有用或者很酷：

- https://www.reddit.com/r/vim/
- https://www.reddit.com/r/neovim/

### 结语

也许刚开始学习你是痛苦的，但任何技能都需要练习才能够熟练掌握。我们没有必要刻意地去学习它，我们要做的只是让它走进我们的生活。当你在实际操作中思考这样好傻，有没有更优雅、更快速的方式完成同样的操作呢？你会自然而然地去访问Vim强大的社区，去寻求快捷的操作或者插件。在这样的一点一滴的过程中，你会自然而然地成为Vim大师。

### 参考链接

- https://missing-semester-cn.github.io/2020/editors/
- https://gitlab.com/wsdjeg/Learn-Vim_zh_cn
